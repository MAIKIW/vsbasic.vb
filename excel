Sub SplitDataUltimatePro()
    Dim wsMain As Worksheet, wsDest As Worksheet
    Dim lastRowMain As Long, i As Long, destRow As Long
    Dim colStudio As Integer, rowHeader As Long
    Dim studioName As String, safeSheetName As String
    Dim cellHeader As Range
    Dim dictSheets As Object ' เปลี่ยนมาจำตัว "Object ชีท" ไว้ในสมองแทนการจำชื่อ
    
    Application.ScreenUpdating = False
    Application.DisplayAlerts = False
    
    Set wsMain = ThisWorkbook.Sheets("Main")
    
    ' เรดาร์หาหัวตารางคำว่า "ค่าย"
    Set cellHeader = wsMain.Cells.Find(What:="ค่าย", LookIn:=xlValues, LookAt:=xlPart)
    If cellHeader Is Nothing Then
        MsgBox "ไม่พบคำว่า 'ค่าย' ในหัวตารางครับ", vbCritical
        Exit Sub
    End If
    
    colStudio = cellHeader.Column
    rowHeader = cellHeader.Row
    lastRowMain = wsMain.Cells(wsMain.Rows.Count, colStudio).End(xlUp).Row
    
    Set dictSheets = CreateObject("Scripting.Dictionary")
    
    ' เริ่มลูปดึงข้อมูล
    For i = rowHeader + 1 To lastRowMain
        studioName = Trim(wsMain.Cells(i, colStudio).Value)
        
        If studioName <> "" Then
            ' ถ้าเป็นการเจอค่ายนี้ครั้งแรก
            If Not dictSheets.Exists(studioName) Then
                
                ' สร้างชื่อชีทที่ปลอดภัย (ลบอักขระต้องห้ามของ Excel ทิ้งให้หมด)
                safeSheetName = Left(studioName, 31)
                safeSheetName = Replace(safeSheetName, "/", "_")
                safeSheetName = Replace(safeSheetName, "\", "_")
                safeSheetName = Replace(safeSheetName, "?", "")
                safeSheetName = Replace(safeSheetName, "*", "")
                safeSheetName = Replace(safeSheetName, "[", "")
                safeSheetName = Replace(safeSheetName, "]", "")
                safeSheetName = Replace(safeSheetName, ":", "")
                
                ' เช็กว่ามีชีทนี้อยู่หรือยัง
                On Error Resume Next
                Set wsDest = ThisWorkbook.Sheets(safeSheetName)
                On Error GoTo 0
                
                If wsDest Is Nothing Then
                    Set wsDest = ThisWorkbook.Sheets.Add(After:=ThisWorkbook.Sheets(ThisWorkbook.Sheets.Count))
                    wsDest.Name = safeSheetName
                Else
                    wsDest.Cells.Clear
                End If
                
                ' ก๊อปปี้หัวตารางไปวาง
                wsMain.Range(wsMain.Cells(rowHeader, 1), wsMain.Cells(rowHeader, colStudio)).Copy Destination:=wsDest.Range("A1")
                
                ' *** ไม้ตาย: สั่งให้ Dictionary จำ Object ชีทไว้เลย จะได้ไม่ต้องควานหาชื่อชีทอีก ***
                Set dictSheets(studioName) = wsDest
            End If
            
            ' ดึง Object ชีทค่ายนั้นมาใช้ตรงๆ จากหน่วยความจำ
            Set wsDest = dictSheets(studioName)
            
            ' หาบรรทัดว่างสุดท้ายของชีทนั้นๆ อัตโนมัติ
            destRow = wsDest.Cells(wsDest.Rows.Count, colStudio).End(xlUp).Row + 1
            
            ' ก๊อปปี้ข้อมูลทีละบรรทัดไปวาง
            wsMain.Range(wsMain.Cells(i, 1), wsMain.Cells(i, colStudio)).Copy Destination:=wsDest.Range("A" & destRow)
        End If
    Next i
    
    ' จัดรูปแบบคอลัมน์ C และ D ให้เป็นวันที่
    Dim key As Variant
    For Each key In dictSheets.keys
        Set wsDest = dictSheets(key)
        wsDest.Columns("C:D").NumberFormat = "dd/mm/yyyy"
        wsDest.Columns.AutoFit
    Next key
    
    Application.ScreenUpdating = True
    Application.DisplayAlerts = True
    
    MsgBox "ทะลวงข้อมูลสำเร็จเรียบร้อยครับ! เช็กแต่ละชีทได้เลย", vbInformation
End Sub
