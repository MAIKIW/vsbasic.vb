Sub SplitDataUltimate()
    Dim wsMain As Worksheet, wsDest As Worksheet
    Dim cellHeader As Range
    Dim colStudio As Integer, rowHeader As Long, lastRow As Long, i As Long
    Dim studioName As String, destRow As Long
    Dim dict As Object
    
    ' 1. ตั้งค่าให้ทำงานที่ชีท Main
    Set wsMain = ThisWorkbook.Sheets("Main")
    
    ' 2. เรดาร์ค้นหาหัวตาราง: หาว่าคำว่า "ค่าย" อยู่บรรทัดไหนและคอลัมน์ไหน
    Set cellHeader = wsMain.Cells.Find(What:="ค่าย", LookIn:=xlValues, LookAt:=xlPart)
    
    If cellHeader Is Nothing Then
        MsgBox "หาหัวตารางคำว่า 'ค่าย' ไม่เจอครับ รบกวนตรวจสอบในชีท Main ว่ามีคำนี้ไหม", vbCritical
        Exit Sub
    End If
    
    colStudio = cellHeader.Column
    rowHeader = cellHeader.Row
    lastRow = wsMain.Cells(wsMain.Rows.Count, colStudio).End(xlUp).Row
    
    If lastRow <= rowHeader Then
        MsgBox "เจอหัวตารางแล้ว แต่ไม่พบข้อมูลหนังด้านล่างเลยครับ", vbExclamation
        Exit Sub
    End If
    
    ' ปิดระบบหน้าจอกะพริบเพื่อความรวดเร็ว
    Application.ScreenUpdating = False
    Application.DisplayAlerts = False
    Set dict = CreateObject("Scripting.Dictionary")
    
    ' 3. เริ่มเดินก๊อปปี้ข้อมูลใต้หัวตารางลงมาทีละบรรทัด
    For i = rowHeader + 1 To lastRow
        studioName = Trim(wsMain.Cells(i, colStudio).Value)
        
        If studioName <> "" Then
            ' ถ้าเพิ่งเจอค่ายนี้ครั้งแรก ให้ล้างชีทเก่าเตรียมไว้
            If Not dict.Exists(studioName) Then
                dict.Add studioName, 2 ' บันทึกไว้ว่าจะเริ่มวางข้อมูลที่บรรทัด 2
                
                On Error Resume Next
                Set wsDest = ThisWorkbook.Sheets(Left(studioName, 31))
                On Error GoTo 0
                
                If wsDest Is Nothing Then
                    Set wsDest = ThisWorkbook.Sheets.Add(After:=ThisWorkbook.Sheets(ThisWorkbook.Sheets.Count))
                    wsDest.Name = Left(studioName, 31)
                Else
                    wsDest.Cells.Clear
                End If
                
                ' ก๊อปปี้หัวตารางไปวางที่ชีทปลายทาง บรรทัดที่ 1
                wsMain.Range(wsMain.Cells(rowHeader, 1), wsMain.Cells(rowHeader, colStudio)).Copy Destination:=wsDest.Range("A1")
            End If
            
            Set wsDest = ThisWorkbook.Sheets(Left(studioName, 31))
            destRow = dict(studioName)
            
            ' ก๊อปปี้ข้อมูลหนังเรื่องนั้นไปวาง
            wsMain.Range(wsMain.Cells(i, 1), wsMain.Cells(i, colStudio)).Copy Destination:=wsDest.Range("A" & destRow)
            
            ' จดจำว่าบรรทัดต่อไปต้องวางที่ไหน
            dict(studioName) = destRow + 1
        End If
    Next i
    
    ' จัดรูปแบบคอลัมน์วันที่ (C และ D) ให้แสดงผลถูกต้อง
    Dim key As Variant
    For Each key In dict.keys
        Set wsDest = ThisWorkbook.Sheets(Left(key, 31))
        wsDest.Columns("C:D").NumberFormat = "dd/mm/yyyy"
        wsDest.Columns.AutoFit
    Next key
    
    Application.ScreenUpdating = True
    Application.DisplayAlerts = True
    
    MsgBox "ดึงข้อมูลมาเรียบร้อยแล้วครับ! ลองเช็กดูที่ชีทค่ายหนังได้เลย", vbInformation
End Sub
