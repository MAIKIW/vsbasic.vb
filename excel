Sub SplitDataByStudio()
    Dim wsMain As Worksheet
    Dim wsTemp As Worksheet
    Dim wsDest As Worksheet
    Dim lastRow As Long
    Dim cell As Range
    Dim studioName As String

    ' ปิดการอัปเดตหน้าจอชั่วคราวเพื่อให้โค้ดรันเสร็จในพริบตา
    Application.ScreenUpdating = False
    Application.DisplayAlerts = False

    Set wsMain = ThisWorkbook.Sheets("รวมค่าย")
    lastRow = wsMain.Cells(wsMain.Rows.Count, "E").End(xlUp).Row

    ' สร้างชีทชั่วคราวเพื่อคัดกรองชื่อค่ายหนังแบบไม่ซ้ำ
    Set wsTemp = ThisWorkbook.Sheets.Add
    wsMain.Range("E1:E" & lastRow).AdvancedFilter Action:=xlFilterCopy, CopyToRange:=wsTemp.Range("A1"), Unique:=True

    ' เริ่มลูปสร้างชีทและดึงข้อมูลตามชื่อค่าย
    For Each cell In wsTemp.Range("A2:A" & wsTemp.Cells(wsTemp.Rows.Count, "A").End(xlUp).Row)
        studioName = cell.Value
        
        If studioName <> "" Then
            ' เช็กว่ามีชีทชื่อค่ายนี้หรือยัง ถ้ามีให้เคลียร์ข้อมูลเก่า ถ้าไม่มีให้สร้างใหม่
            On Error Resume Next
            Set wsDest = ThisWorkbook.Sheets(studioName)
            On Error GoTo 0
            
            If wsDest Is Nothing Then
                Set wsDest = ThisWorkbook.Sheets.Add(After:=ThisWorkbook.Sheets(ThisWorkbook.Sheets.Count))
                wsDest.Name = studioName
            Else
                wsDest.Cells.Clear
            End If
            
            ' ใช้ฟิลเตอร์ดึงข้อมูลเฉพาะค่ายนั้นไปวางที่ชีทใหม่
            wsMain.Range("A1:E" & lastRow).AutoFilter Field:=5, Criteria1:=studioName
            wsMain.Range("A1:E" & lastRow).SpecialCells(xlCellTypeVisible).Copy Destination:=wsDest.Range("A1")
            
            ' จัดรูปแบบคอลัมน์ C และ D ให้เป็นวันที่
            wsDest.Columns("C:D").NumberFormat = "dd/mm/yyyy"
            wsDest.Columns.AutoFit
            
            Set wsDest = Nothing
        End If
    Next cell

    ' ล้างตัวกรองและลบชีทชั่วคราวทิ้ง
    wsMain.AutoFilterMode = False
    wsTemp.Delete

    Application.ScreenUpdating = True
    Application.DisplayAlerts = True

    MsgBox "แยกข้อมูลค่ายหนังเสร็จเรียบร้อยแล้ว!", vbInformation
End Sub
